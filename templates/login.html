<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MEIL Safety Portal | Login</title>

    <!-- PWA Manifest & Icons -->
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <link rel="icon" type="image/png" sizes="192x192" href="{{ url_for('static', filename='images/icon-192.png') }}">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='images/icon-512.png') }}">
    <meta name="theme-color" content="#5a67f2">
    
    <!-- Fonts and Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    
    <style>
        /* --- THEME & ANIMATION --- */
        :root {
            --primary-blue: #5a67f2;
            --primary-blue-dark: #4953d3;
            --primary-blue-light: #eaefff;
            --primary-blue-glow: rgba(90, 103, 242, 0.15); 
            --text-dark: #2c3e50;
            --text-light: #7f8c8d;
            --bg-light: #f8f9fa;
            --white: #ffffff;
            --border-color-light: #eef0f7;
            --shadow-subtle: 0 5px 15px rgba(0, 0, 0, 0.04);
            --transition-smooth: 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            height: 100%;
            width: 100%;
            font-family: 'Poppins', sans-serif;
            overflow: hidden; 
            background-color: var(--bg-light);
            background-image: 
                radial-gradient(circle at 10% 10%, var(--primary-blue-light) 0%, transparent 60%),
                radial-gradient(circle at 85% 90%, var(--primary-blue-light) 0%, transparent 60%);
        }

        /* --- APP CONTAINER --- */
        .app-view {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.97) translateY(10px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        /* --- ADVANCED LOADER STYLES (MODIFIED & ENHANCED) --- */
        .loading-wrapper {
            width: 100%;
            max-width: 420px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            /* No longer need fade out transition here, it's handled by a class */
        }
        
        .logo-animation-container {
            position: relative;
            width: 120px;
            height: 120px;
            margin-bottom: 25px;
            animation: fadeIn 0.8s 0.2s cubic-bezier(0.25, 1, 0.5, 1) both;
        }

        .logo {
            width: 100px; height: 100px; z-index: 2;
            position: absolute; top: 10px; left: 10px; /* Centered in 120px container */
            filter: drop-shadow(0 8px 15px rgba(0,0,0,0.08));
            animation: heartbeat 1.5s 1s ease-in-out infinite;
            transition: transform 0.5s var(--transition-smooth), opacity 0.5s ease;
        }

        .loading-wrapper.is-hiding .logo {
             transform: scale(0);
             opacity: 0;
        }

        .logo-animation-container::before,
        .logo-animation-container::after {
            content: ''; position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); border: 3px solid var(--primary-blue-glow);
            border-radius: 50%; z-index: 1; animation: radiate 2s 1s ease-out infinite;
        }

        .logo-animation-container::after { animation-delay: 1.25s; }
        
        #animated-text-container {
            /* This container will have its transform animated for the exit */
            transition: transform 0.5s var(--transition-smooth), opacity 0.5s ease;
        }
        .loading-wrapper.is-hiding #animated-text-container {
             transform: translateY(-20px);
             opacity: 0;
        }

        /* Styling for the advanced text effect */
        #animated-text {
            font-size: 28px; font-weight: 700;
            color: var(--primary-blue-dark); letter-spacing: 1px;
            min-height: 40px; /* Prevent layout shift */
            display: flex; /* Aligns letter spans */
            overflow: hidden; /* Clips the letters as they slide in */
        }
        
        /* Each letter will be a span */
        #animated-text span {
            display: inline-block;
            opacity: 0;
            transform: translateY(100%);
            transition: transform 0.6s cubic-bezier(0.2, 1, 0.3, 1), opacity 0.6s ease;
        }
        
        #animated-text.visible span {
            opacity: 1;
            transform: translateY(0);
        }

        @keyframes heartbeat {
            0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); }
        }

        @keyframes radiate {
            from { width: 80%; height: 80%; opacity: 1; }
            to { width: 220%; height: 220%; opacity: 0; }
        }
        /* --- END OF ADVANCED LOADER STYLES --- */

        /* --- LOGIN CONTAINER --- */
        .login-container {
            width: 100%;
            max-width: 360px; 
            text-align: center;
            display: none; /* Hidden by default */
            opacity: 0;
            transform: scale(0.97) translateY(10px); /* Initial state for animation */
            transition: opacity 0.8s ease-in-out, transform 0.8s cubic-bezier(0.25, 1, 0.5, 1);
        }
        
        .login-header { margin-bottom: 30px; }
        .login-header h2 { font-size: 24px; font-weight: 700; color: var(--text-dark); }
        form { display: flex; flex-direction: column; gap: 16px; }
        .input-group { position: relative; }
        .input-group > i { position: absolute; left: 18px; top: 50%; transform: translateY(-50%); font-size: 20px; color: #bdc3c7; transition: color 0.3s ease; }
        #togglePassword { left: auto; right: 18px; cursor: pointer; }
        .input-field { width: 100%; padding: 14px 18px 14px 50px; border-radius: 14px; border: 1px solid var(--border-color-light); background-color: var(--white); box-shadow: var(--shadow-subtle); font-size: 15px; font-family: 'Poppins', sans-serif; color: var(--text-dark); transition: all 0.3s ease; }
        input#password { padding-right: 50px; }
        .input-field::placeholder { color: var(--text-light); }
        .input-field:focus { outline: none; border-color: var(--primary-blue); background-color: var(--white); box-shadow: 0 0 0 4px var(--primary-blue-light); }
        .input-field:focus + i, .input-field:focus ~ #togglePassword { color: var(--primary-blue); }
        .role-selector-container { text-align: left; }
        .role-selector-container label { margin-top: 8px; margin-bottom: 12px; font-weight: 600; color: var(--text-dark); display: block; }
        .role-selector { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .role-selector input[type="radio"] { display: none; }
        .role-option { display: flex; align-items: center; justify-content: flex-start; padding: 12px 16px; border: 1px solid var(--border-color-light); border-radius: 14px; cursor: pointer; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); background-color: var(--white); box-shadow: var(--shadow-subtle); }
        .role-option:hover { transform: translateY(-3px); border-color: var(--primary-blue); box-shadow: 0 6px 15px rgba(90, 103, 242, 0.1); }
        .role-option i { font-size: 22px; color: var(--text-dark); margin-right: 10px; transition: color 0.3s ease; }
        .role-option span { font-size: 14px; font-weight: 500; color: var(--text-dark); transition: color 0.3s ease; }
        .role-selector input[type="radio"]:checked + .role-option { background-color: var(--primary-blue-light); border-color: var(--primary-blue); transform: translateY(-1px); }
        .role-selector input[type="radio"]:checked + .role-option i,
        .role-selector input[type="radio"]:checked + .role-option span { color: var(--primary-blue-dark); font-weight: 600; }
        button[type="submit"] { background: var(--primary-blue); color: #fff; border: none; padding: 15px; border-radius: 14px; font-size: 16px; font-weight: 600; font-family: 'Poppins', sans-serif; cursor: pointer; transition: all 0.3s ease; margin-top: 15px; box-shadow: 0 6px 20px rgba(90, 103, 242, 0.25); letter-spacing: 0.5px; }
        button[type="submit"]:hover { transform: translateY(-3px); background: var(--primary-blue-dark); box-shadow: 0 8px 25px rgba(90, 103, 242, 0.3); }
        .message { margin-bottom: 20px; font-size: 14px; padding: 10px; border-radius: 8px; }
        .error { color: #D8000C; background-color: #FFBABA; }
        .success { color: #270; background-color: #DFF2BF; }
        .signup-link, footer { margin-top: 25px; font-size: 14px; color: var(--text-dark); }
        .signup-link a { color: var(--primary-blue-dark); text-decoration: none; font-weight: 600; }
        .signup-link a:hover { text-decoration: underline; }
        footer { margin-top: 8px; font-size: 13px; color: var(--text-light); }
    </style>
</head>
<body>

    <div class="app-view">
        <!-- ADVANCED LOADING SCREEN -->
        <div class="loading-wrapper">
            <div class="logo-animation-container">
                <img src="{{ url_for('static', filename='logo.png') }}" alt="MEIL Safety Portal Logo" class="logo">
            </div>
            <div id="animated-text-container">
                <h2 id="animated-text"></h2>
            </div>
        </div>
        
        <!-- EXISTING LOGIN INTERFACE -->
        <div class="login-container">
            <div class="login-header">
                <h2>MEIL Safety Portal</h2>
            </div>
            <div id="messageContainer">
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <p class="message {{ category }}">{{ message }}</p>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
            </div>
            <form action="{{ url_for('login') }}" method="POST" id="loginForm">
                <div class="input-group">
                    <input type="text" id="userid" name="user_id" class="input-field" placeholder="Enter your ID" required>
                    <i class='bx bxs-user'></i>
                </div>
                <div class="input-group">
                    <input type="password" id="password" name="password" class="input-field" placeholder="Enter your Password" required>
                    <i class='bx bxs-lock-alt'></i>
                    <i class='bx bx-hide' id="togglePassword"></i>
                </div>
                <div class="role-selector-container">
                    <label>Select Your Role</label>
                    <div class="role-selector">
                        <input type="radio" id="role-admin" name="role" value="admin" required><label for="role-admin" class="role-option"><i class='bx bxs-crown'></i><span>Admin</span></label>
                        <input type="radio" id="role-so" name="role" value="safety_officer"><label for="role-so" class="role-option"><i class='bx bxs-hard-hat'></i><span>Officer</span></label>
                        <input type="radio" id="role-sm" name="role" value="manager"><label for="role-sm" class="role-option"><i class='bx bxs-briefcase-alt-2'></i><span>Manager</span></label>
                        <input type="radio" id="role-employee" name="role" value="employee"><label for="role-employee" class="role-option"><i class='bx bxs-user-detail'></i><span>Employee</span></label>
                    </div>
                </div>
                <button type="submit">Secure Login</button>
            </form>
            <div class="signup-link">
                Don't have an account? <a href="{{ url_for('signup') }}">Sign Up Now</a>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- Part 1: ADVANCED Loading Screen and Transition Logic ---
            const loadingWrapper = document.querySelector('.loading-wrapper');
            const loginContainer = document.querySelector('.login-container');
            const animatedTextEl = document.getElementById('animated-text');
            
            if (loadingWrapper && loginContainer && animatedTextEl) {
                const words = ["Health", "Safety", "Environment"];
                let wordIndex = 0;
                let wordInterval;

                // Function to animate letters of a single word
                function animateWord(word) {
                    animatedTextEl.innerHTML = ''; // Clear previous word
                    animatedTextEl.classList.remove('visible');

                    // Create a span for each letter with a staggered delay
                    word.split('').forEach((letter, index) => {
                        const span = document.createElement('span');
                        span.textContent = letter;
                        span.style.transitionDelay = `${index * 50}ms`;
                        animatedTextEl.appendChild(span);
                    });

                    // Trigger the animation by adding the visible class
                    setTimeout(() => animatedTextEl.classList.add('visible'), 50);
                }
                
                // Function to cycle through the words
                function cycleWords() {
                    animateWord(words[wordIndex]);
                    wordIndex = (wordIndex + 1) % words.length;
                }
                
                cycleWords(); // Show the first word immediately
                wordInterval = setInterval(cycleWords, 1500); // Cycle every 1.5 seconds
                
                const totalLoadingTime = (words.length * 1500) - 500; // Run for a faster cycle

                // The transition to the login form
                setTimeout(() => {
                    clearInterval(wordInterval);

                    // Add a class to animate out the loader elements
                    loadingWrapper.classList.add('is-hiding');
                    
                    // After the loader's exit animation completes...
                    setTimeout(() => {
                        loadingWrapper.style.display = 'none';

                        // Make login container appear with its own animation
                        loginContainer.style.display = 'block';
                        setTimeout(() => {
                             loginContainer.style.opacity = '1';
                             loginContainer.style.transform = 'scale(1) translateY(0)';
                        }, 50);

                    }, 500); // Must match the exit animation duration (0.5s)

                }, totalLoadingTime); 
            }

            // --- Part 2: Existing Password Toggle Logic ---
            const togglePassword = document.querySelector('#togglePassword');
            const password = document.querySelector('#password');

            if (togglePassword && password) {
                togglePassword.addEventListener('click', function () {
                    const type = password.getAttribute('type') === 'password' ? 'text' : 'password';
                    password.setAttribute('type', type);
                    
                    this.classList.toggle('bx-show');
                    this.classList.toggle('bx-hide');
                });
            }
        });

        // --- Part 3: PWA Service Worker Registration ---
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', () => {
            navigator.serviceWorker.register("{{ url_for('sw') }}")
              .then(registration => {
                console.log('ServiceWorker registration successful with scope: ', registration.scope);
              })
              .catch(err => {
                console.log('ServiceWorker registration failed: ', err);
              });
          });
        }
    </script>
</body>
</html>